<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cistercian Number Laboratory</title>

<style>
  /* Register SGA for the page and for the printable view */
  @font-face {
    font-family: 'Sga Regular';
    src: url('fonts/Sga-Regular.woff2') format('woff2'),
         url('fonts/Sga-Regular.woff') format('woff'),
         url('fonts/Sga-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }

  body {
    font-family: Arial, sans-serif;
    color: #00ff00;
    background: black;
    margin: 0;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 18px;
  }

  #container {
    text-align: center;
    width: 100%;
    max-width: 1100px;
    background-color: rgba(0, 0, 0, 0.85);
    padding: 18px;
    box-shadow: 0 0 20px #00ff00;
    border: 2px solid #00ff00;
    margin: 18px 0;
    z-index: 1;
  }

  input[type="number"], input[type="text"], button {
    background-color: black;
    color: #00ff00;
    border: 1px solid #00ff00;
    padding: 8px 10px;
    margin: 6px;
    font-family: inherit;
  }
  button:hover { background-color:#00ff00; color:black; cursor:pointer; }

  .result {
    font-size: 3em;
    margin-top: 10px;
    font-family: 'Sga Regular', serif !important; /* Always use SGA font for result */
  }

  .example {
    font-size: 1.2em;
    margin: 6px;
    display: inline-block;
    box-sizing: border-box;
    padding: 8px;
    border: 1px solid #00ff00;
    font-family: 'Sga Regular', serif !important;
  }

  /* Keep glyph internals unspaced; wrap each 4-digit group in .cg for spacing between groups */
  .glyphs {
    flex:1;
    text-align:center;
    font-size:2.0em;
    letter-spacing: 0;      /* no spacing between codepoints inside a composite glyph */
    white-space: nowrap;
    font-family: 'Sga Regular', serif !important;
  }
  .glyphs .cg {
    display:inline-block;
    letter-spacing: 0;
    margin: 0 0.35em;       /* spacing BETWEEN groups */
    vertical-align: middle;
  }
  .glyphs .cg:last-child { margin-right: 0; }

  /* Worksheet layout */
  .worksheet-page { width:8.5in; max-width:100%; height:auto; margin:auto; padding:0.5in;
    border:2px solid #00ff00; margin-bottom:16px; color:#00ff00; box-sizing:border-box; position:relative; background:transparent; }
  .page-header { text-align:center; font-size:1.0em; margin-bottom:0.5em; }
  .page-grid { display:flex; flex-direction:column; gap:10px; }
  .worksheet-row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .margin-number { width:200px; text-align:left; font-family:monospace; font-size:0.9em; opacity:0.9; }
  .blanks { width:280px; text-align:right; }
  .blank { display:inline-block; width:60px; border-bottom:1px solid #00ff00; margin:0 6px; height:1.2rem; vertical-align:bottom; }

  /* Mobile: keep margin numbers & blanks visible but compact */
  @media (max-width:700px) {
    .margin-number { width:80px; font-size:0.75em; opacity:0.85; }
    .blanks { width:140px; }
    .blank { width:32px; }
    .glyphs { font-size:1.4em; letter-spacing:0; }
  }
</style>
</head>
<body>
  <div id="container">
    <h1>Cistercian Number Laboratory</h1>

    <div style="margin-top:8px;">
 <a href="https://standardgalactic.github.io/generate-worksheet.html" target="_blank" style="color:#00ff00;text-decoration:none;">
    https://standardgalactic.github.io/generate-worksheet.html
  </a>
      <label>Number: <input id="arabicNumber" type="text" placeholder="e.g. 1234 or 98765432" value="1234"></label>
      <button onclick="translateNumber()">Translate</button>
      <button onclick="generateExamples()">Regenerate Examples</button>
    </div>

    <p id="cistercianResult" class="result" aria-live="polite"></p>

    <div class="examples" style="margin-top:12px;">
      <h3>Examples</h3>
      <div id="examples-container" style="display:flex;flex-wrap:wrap;justify-content:center;"></div>
    </div>

    <hr style="border-color:#004400;margin:18px 0;width:95%">

    <div style="margin-top:8px;">
      <h3>Worksheet Generator</h3>
      <label>Pages: <input id="numPages" type="number" min="1" max="50" value="1"></label>
      <label>Rows/Page: <input id="rowsPerPage" type="number" min="1" max="50" value="8"></label>
      <button onclick="generateWorksheets()">Generate Worksheets</button>
      <button onclick="exportWorksheetsPDF()">Export Worksheets to PDF</button>
    </div>

    <div id="worksheets" style="margin-top:16px;"></div>
  </div>

<script>
/* -----------------------
   Translator & generator
   ----------------------- */

function arabicToCistercian(num) {
    const u = {'0':'\uEBA0','1':'\uEBA1','2':'\uEBA2','3':'\uEBA3','4':'\uEBA4','5':'\uEBA5','6':'\uEBA6','7':'\uEBA7','8':'\uEBA8','9':'\uEBA9'};
    const t = {'1':'\uEBB1','2':'\uEBB2','3':'\uEBB3','4':'\uEBB4','5':'\uEBB5','6':'\uEBB6','7':'\uEBB7','8':'\uEBB8','9':'\uEBB9'};
    const h = {'1':'\uEBC1','2':'\uEBC2','3':'\uEBC3','4':'\uEBC4','5':'\uEBC5','6':'\uEBC6','7':'\uEBC7','8':'\uEBC8','9':'\uEBC9'};
    const k = {'1':'\uEBD1','2':'\uEBD2','3':'\uEBD3','4':'\uEBD4','5':'\uEBD5','6':'\uEBD6','7':'\uEBD7','8':'\uEBD8','9':'\uEBD9'};

    if (typeof num === 'string') num = parseInt(num, 10);
    if (!Number.isFinite(num) || num < 0) return '';

    if (num === 0) return u['0'];

    let res = '';
    let n = Math.floor(num);
    while (n > 0) {
      const chunk = n % 10000;
      const units = chunk % 10;
      const tens = Math.floor(chunk / 10) % 10;
      const hundreds = Math.floor(chunk / 100) % 10;
      const thousands = Math.floor(chunk / 1000) % 10;
      // units -> tens -> hundreds -> thousands per chunk (matches your working translator)
      const part = (u[units]||'') + (t[tens]||'') + (h[hundreds]||'') + (k[thousands]||'');
      res = part + res;
      n = Math.floor(n / 10000);
    }
    return res;
}

/* Translate UI */
function translateNumber() {
  const input = document.getElementById('arabicNumber').value.trim();
  if (!/^\d+$/.test(input)) {
    alert('Please enter a valid non-negative integer (digits only).');
    return;
  }
  const glyph = arabicToCistercian(input);
  const el = document.getElementById('cistercianResult');
  el.textContent = '';
  const span = document.createElement('span');
  span.className = 'cg';
  span.style.fontFamily = "'Sga Regular', 'Sga-Regular', serif";
  span.textContent = glyph || '(empty)';
  el.appendChild(span);
}

/* Examples UI */
function generateExamples() {
  const examplesContainer = document.getElementById('examples-container');
  examplesContainer.innerHTML = '';
  const sample = [0,4,42,1234,98765432,10000,10001,20003004];
  sample.forEach(n => {
    const div = document.createElement('div');
    div.className = 'example';
    div.style.fontFamily = "'Sga Regular', 'Sga-Regular', serif";
    const label = document.createElement('span');
    label.textContent = `${n}: `;
    const glyph = document.createElement('span');
    glyph.className = 'cg';
    glyph.style.fontFamily = "'Sga Regular', 'Sga-Regular', serif";
    glyph.textContent = arabicToCistercian(n);
    div.appendChild(label);
    div.appendChild(glyph);
    examplesContainer.appendChild(div);
  });
}

/* Worksheet generator */
function generateWorksheets() {
  const numPages = +document.getElementById("numPages").value || 1;
  const rows = +document.getElementById("rowsPerPage").value || 8;
  const container = document.getElementById("worksheets");
  container.innerHTML = '';

  const FONT_FAMILY = "'Sga Regular', 'Sga-Regular', serif";

  for (let p = 1; p <= numPages; p++) {
    const page = document.createElement('div');
    page.className = "worksheet-page " + (p % 2 === 0 ? "margin-right" : "margin-left");

    const header = document.createElement('div');
    header.className = 'page-header';
    header.textContent = `Page ${p}`;
    page.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'page-grid';

    for (let r = 0; r < rows; r++) {
      const groupNumbers = [];
      const glyphNodes = [];

      for (let j = 0; j < 4; j++) {
        const v = Math.floor(Math.random() * 10000);
        groupNumbers.push(v.toString().padStart(4, '0'));
        const span = document.createElement('span');
        span.className = 'cg';
        span.style.fontFamily = FONT_FAMILY;
        span.textContent = arabicToCistercian(v);
        glyphNodes.push(span);
      }

      const row = document.createElement('div');
      row.className = 'worksheet-row';
// Build a 2Ã—2 matrix (two across, two down)
const marginDiv = document.createElement('div');
marginDiv.className = 'margin-number';

// Split the four groups into two rows of two numbers
const topRow = document.createElement('div');
topRow.className = 'num-row';
topRow.textContent = groupNumbers.slice(0, 2).join('  ');

const bottomRow = document.createElement('div');
bottomRow.className = 'num-row';
bottomRow.textContent = groupNumbers.slice(2).join('  ');

marginDiv.appendChild(topRow);
marginDiv.appendChild(bottomRow);

      const glyphDiv = document.createElement('div');
      glyphDiv.className = 'glyphs';
      glyphDiv.style.fontFamily = FONT_FAMILY;
      glyphDiv.style.whiteSpace = 'nowrap';
      glyphNodes.forEach(n => glyphDiv.appendChild(n));

      const blanks = document.createElement('div');
      blanks.className = 'blanks';
      blanks.innerHTML = `<span class="blank"></span><span class="blank"></span>
                          <span class="blank"></span><span class="blank"></span>`;

      row.appendChild(marginDiv);
      row.appendChild(glyphDiv);
      row.appendChild(blanks);


      grid.appendChild(row);
    }

    page.appendChild(grid);
    container.appendChild(page);
  }
}

/* -----------------------
   Export: printable fallback (black-on-white worksheets only)
   ----------------------- */

/*
  exportWorksheetsPDF()

  Uses an improved waiting strategy to avoid the "blank print dialog" symptom:
  - opens a new window, writes the minimal HTML
  - waits for the new window's document readyState and for fonts to be ready (document.fonts.ready)
  - then calls print()

  This avoids printing before fonts/layout have loaded (the common cause of a blank print dialog).
*/
async function exportWorksheetsPDF() {
  const sheets = document.getElementById('worksheets');
  if (!sheets || !sheets.innerHTML.trim()) {
    alert('No worksheets to export â€” generate worksheets first.');
    return;
  }

  // Clone worksheet HTML
const printable = document.getElementById('worksheets').cloneNode(true);


// Build printable styles (white background, SGA font reference)
const printableStyle = `
  <style>
    @font-face {
      font-family: 'Sga Regular';
      src: url('fonts/Sga-Regular.woff2') format('woff2'),
           url('fonts/Sga-Regular.woff') format('woff'),
           url('fonts/Sga-Regular.ttf') format('truetype');
      font-display: swap;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: #fff !important;
  color: #000 !important;
      font-family: Arial, sans-serif;
    }

    .worksheet-page {
      width: 8.5in;
      box-sizing: border-box;
      padding: 0.45in;
      border: 1px solid #000 !important;
 color: #000 !important;
      margin: 0 auto 0.45in;
      background: #fff;
    }

    .page-header {
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5em;
    }
.margin-number {
  min-width: 1.8in !important;
  text-align: left !important;
  font-family: monospace;
  font-size: 0.9em;
  opacity: 0.9;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: flex-start;
  gap: 0.25em;
}

.margin-number .num-row {
  display: flex;
  justify-content: space-between;
  width: 100%;
  letter-spacing: 1px;
}

.glyphs {
  flex: 1;
  text-align: center;
  font-family: 'Sga Regular', serif;
  font-size: 2.3em;
  line-height: 1.2;
  white-space: nowrap;
  letter-spacing: 0;
  transform: translateY(-2px);
}

.cg {
  display: inline-block;
  margin: 0 0.35em;
  letter-spacing: 0;
  vertical-align: middle;
}

/* === New grid-style blanks === */
.blanks {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr);   /* two columns */
  grid-template-rows: repeat(2, auto);     /* two rows */
  gap: 0.4em 0.8em;
  width: 1.8in !important;
  justify-items: right;
  align-items: end;
}

.blank {
  display: inline-block;
  width: 0.7in;
  border-bottom: 1px solid #000 !important;
  height: 1.1rem;
  vertical-align: bottom;
}

/* Page layout adjustments */
.worksheet-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5in;
}

@media print {
  @page {
    size: letter portrait;
    margin: 0.75in;
  }

  html, body {
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
    color: #000 !important;
    overflow: visible !important;
  }

  body {
    transform: none !important;
    width: 100% !important;
    max-width: 8in !important;
    margin: 0 auto !important;
  }

  .worksheet-page {
    page-break-after: always;
    width: 7.9in !important;
    margin: 0 auto 0.4in !important;
    border: 1px solid #000 !important;
    padding: 0.45in !important;
    box-sizing: border-box !important;
  }
}


  body {
    transform: none !important;        /* remove all transforms */
    width: 100% !important;
    max-width: 8in !important;         /* fits within letter page minus margins */
    margin: 0 auto !important;         /* center horizontally */
  }

  .worksheet-page {
    page-break-after: always;
    width: 7.9in !important;           /* guaranteed fit inside print margins */
    margin: 0 auto 0.4in !important;   /* vertical spacing between pages */
    border: 1px solid #000 !important;
    padding: 0.45in !important;
    box-sizing: border-box !important;
  }

  .margin-number {
    min-width: 1.8in !important;       /* ensures column stays visible */
    margin-left: 0 !important;
    text-align: left !important;
  }
}


  </style>
`;


  // Save current body so we can restore it
  const originalDoc = {
    title: document.title,
    head: document.head.cloneNode(true),
    body: document.body.cloneNode(true)
  };

  // Create printable HTML and set it to document
 const html = `
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Cistercian Worksheet</title>
    ${printableStyle}
  </head>
  <body>
    <div style="text-align:center;margin-bottom:1em;">
      <h1 style="margin:0;font-family:'Sga Regular',serif;">Cistercian Number Laboratory</h1>
      <p style="margin:4px 0;font-size:0.9em;">
        <a href="https://standardgalactic.github.io/generate-worksheet.html" target="_blank" style="color:#000;text-decoration:none;">
          https://standardgalactic.github.io/generate-worksheet.html
        </a>
      </p>
      <hr style="margin-top:8px;margin-bottom:16px;border:none;border-top:1px solid #000;width:90%;">
    </div>
    ${printable.outerHTML}
  </body>
</html>`;


  // Replace current document with printable content (preserves same origin so fonts load)
  document.open();
  document.write(html);
  document.close();

  // Wait for fonts and layout to settle, then print and restore
  try {
    if (document.fonts && document.fonts.ready) {
      await document.fonts.ready;
    } else {
      // small delay when font API not available
      await new Promise(res => setTimeout(res, 300));
    }
    // Trigger print (user will be able to Save as PDF)
    window.print();
  } catch (err) {
    console.warn('Print failed', err);
    alert('Print failed; the printable view is shown â€” use browser Print to save as PDF.');
  } finally {
    // small delay to allow print dialog to open before restoring (helps some browsers)
    setTimeout(() => {
      try {
        // Restore original head and body (we used clones)
        document.open();
        // restore head: we must serialize the original head clone
        // To be safe, reuse outerHTML of the cloned head and body
        const restoredHTML = '<!doctype html><html>' +
          originalDoc.head.outerHTML +
          '<body>' + originalDoc.body.innerHTML + '</body></html>';
        document.write(restoredHTML);
        document.close();
        // restore title
        document.title = originalDoc.title || 'Cistercian Number Laboratory';
      } catch (e) {
        // If restore fails (some browsers), inform user to reload
        console.error('Failed to restore app after printing', e);
        alert('Printed. Reload the page to continue using the app.');
      }
    }, 800);
  }
}

/* Populate examples on load */
generateExamples();
</script>
</body>
</html>